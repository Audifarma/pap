<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>pap</title>
        <meta HTTP-EQUIV="Content-Type" content="text/html; charset=iso-8859-1" />
        <script type="text/javascript" src="cordova.js"></script>
        <link rel="stylesheet" href="JQ/jquery.mobile-1.4.5.min.css" />
		<script src="JQ/jquery.min.js"></script>
		<script src="JQ/jquery.mobile-1.4.5.min.js"></script>
                <script src="js/markerwithlabel.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=geometry"></script>
        <script>
            function cargarMapa(){
                $( document ).on( "pageinit", "#confirmar", function(e,data) {
                    var defaultPos = new google.maps.LatLng(4.807259, -75.744327);
                    function esperarGps(){
                        cordova.plugins.diagnostic.isLocationEnabled(
                            function(enabled){
                                if (enabled){setTimeout(validarGps, 2000)}
                                else {setTimeout(esperarGps, 2000)}
                        }, function(error){console.error("Error: "+error);});
                    }
                    function opcionesNoGps(buttonIndex) {
                        if (buttonIndex==1){
                            alert("Listado de los centros de atención");
                            MuestraMapa(defaultPos);
                        }
                        if (buttonIndex==2){
                            cordova.plugins.diagnostic.switchToLocationSettings();
                            esperarGps();
                        }
                    }
                    function validarGps(){
                        if (navigator.geolocation) {
                            function exito(pos) {
                                MuestraMapa(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
                            }
                            function falla(error) {
                                navigator.notification.confirm(
                                    'Se recomienda Activar el GPS para que el proceso sea automático. \nSi lo prefiere puede Seleccionar el centro de atención manualmente. ',  // message
                                    opcionesNoGps,                  // callback to invoke
                                    'GPS Desactivado',            // title
                                    ['Mostrar los Centros','Activar GPS']             // buttonLabels
                                );
                            }
                            //maximumAge- Guarda la posicion por 5 minutos 
                            //enableHighAccuracy: Se tratan de obtener los mejores resultados posible del GPS
                            //timeout: el tiempo maximo que se espera para obtener la posicion en este caso 5 segundos
                            var options = {maximumAge: 500000, enableHighAccuracy:true, timeout: 5000};
                            navigator.geolocation.getCurrentPosition(exito, falla, options );
                        }//FIN IF
                        else {
                            MuestraMapa(defaultPos);  // No soporta geolocalizacion y dibuja el mapa en posicion Default
                        }
                    }
                    //FUNCION DIBUJAR MAPa
                    function MuestraMapa(latlng) {

                        var myOptions = {
                            zoom: 13,
                            center: latlng,
                            disableDefaultUI: true,
                            mapTypeId: google.maps.MapTypeId.ROADMAP};

                        var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
                        var infowindow = new google.maps.InfoWindow({position: latlng,content: '<p>Mi posición</p>'+latlng});
                        var infowindowCaf = new google.maps.InfoWindow({position: latlng,content: '<p>Nombre de Caf</p>'});
                          
                        var marker = new google.maps.Marker({
                                position: latlng,
                                map: map,
                                title: "Mi posición",
                                animation: google.maps.Animation.DROP});
                        
                        setMarkers(map);
                        function setMarkers(map) {
                            var distancia;
                            var cafImgen = 'images/audifarma.png';
                            var cafs = [
                                ['caf 1', 4.807572, -75.731000, 1],
                                ['caf 2', 4.804423, -75.739497, 2]
                              ];            
                            for (var i = 0; i < cafs.length; i++) {
                              var caf = cafs[i];
                              var marker = new google.maps.Marker({
                                position: {lat: caf[1], lng: caf[2]},
                                map: map,
                                icon: cafImgen,
                                title: caf[0],
                                zIndex: caf[3],
                                label: caf[3].toString()
                              });
                                   
                                   ventana_detalle(marker, (google.maps.geometry.spherical.computeDistanceBetween(latlng, new google.maps.LatLng(caf[1], caf[2]))).toFixed(0).toString());

                            }
                            
                        }
                        
                        function ventana_detalle(marker, distancia) {
                            var infowindow = new google.maps.InfoWindow({
                              content: marker.title+'<br> La Distancia al caf es: '+distancia+' metros'
                            });

                            marker.addListener('click', function() {
                              infowindow.open(marker.get('map'), marker);
                            });
                          }
                        

                                       
                                          
                        //google.maps.event.addListener(marker, 'click', function() {infowindow.open(map,marker);});
                        //google.maps.event.addListener(caf, "click", function (e) { infowindowCaf.open(map, this); });

                    }// Fin muestra mapa
                    validarGps();
                });
            }
        </script>
        <style>
            #map-canvas{
                height:70%;
                width:100%;
                padding:0;
                position:absolute !important;
                top:40px;
                righ:0px;
                bottom:0px !important;
                left:0px !important;
            }
               .labels {
                    color: red;
                    background-color: white;
                    font-family: "Lucida Grande", "Arial", sans-serif;
                    font-size: 10px;
                    font-weight: bold;
                    text-align: center;
                    width: 40px;     
                    border: 2px solid black;
                    white-space: nowrap;
                  }
        </style>
    </head>

    <body>
    	<div data-role="page" id="pap" style="background-color: #1CAAA0;color: white;text-align: center">        	

            <div role="main" class="ui-content">
		<img src="images/cabecera.png" alt="PAP" style="width: 100%">
                <div class="ui-grid-a">
                    <div class="ui-block-a"><a href="#confirmar" onclick="cargarMapa()"><div class="ui-bar" style="height:150px;background-color: #660099;color:white;font-weight:none;padding-top: 20px">Confirmar Orden</div></a></div>
                    <div class="ui-block-b">                                            <div class="ui-bar" style="height:150px;background-color: #FF9900;color:white;font-weight:none;padding-top: 20px">Mis Órdenes</div></div>
                </div><!-- /grid-a -->

                <div class="ui-grid-a">
                        <div class="ui-block-a">                                        <div class="ui-bar" style="height:150px;background-color: #009933;color:white;font-weight:none;padding-top: 20px">Información de Domicilio</div></div>
                        <div class="ui-block-b">                                        <div class="ui-bar" style="height:150px;background-color: #FF0066;color:white;font-weight:none;padding-top: 20px">Utilidades</div></div>
                </div><!-- /grid-a -->

            </div><!-- /content -->

        </div>

        <div id="confirmar" data-role="page" data-url="map-page">
            <div data-role="header" data-position="fixed">
                <a href="#" class="ui-btn ui-corner-all ui-icon-carat-l ui-btn-icon-notext" data-rel="back">Back Icon</a>
                <h1>Ordenar</h1>
            </div>
            <div id="paginaMapa" role="main" class="ui-content">
                <div id="map-canvas">
                </div>
                <div style="position: absolute;top: 75%">
                    <h3>Caf más cercano según tu posición</h3>
                    <h3>Detalle</h3>
                    <h3>Nombre</h3>
                    <h3>Número de Orden</h3>
                </div>
            </div>
        </div>
    </body>
</html>
